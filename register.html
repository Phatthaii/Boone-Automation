<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ - ServiceBook</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=1" />
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- DEBUG: Show errors on screen -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed; top:0; left:0; right:0; background:red; color:white; padding:20px; z-index:9999; font-size:12px; overflow:scroll; max-height:50vh;';
            div.innerText = 'Error: ' + msg + '\nLine: ' + line + '\nURL: ' + url;
            document.body.appendChild(div);
            // Hide loading if error
            const loader = document.getElementById("loadingMessage");
            if (loader) loader.style.display = 'none';
        };
    </script>
</head>

<body>

    <div class="background-overlay"></div>
    <div class="container">
        <header>
            <div class="logo-area">
                <i class="fas fa-store fa-3x"></i>
            </div>
            <h1>‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà <span style="font-size:12px; color:#ccc;">(v1.1)</span></h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </header>

        <form id="registerForm">
            <!-- Hidden Fields -->
            <input type="hidden" id="ownerLineId" />
            <input type="hidden" id="ownerDisplayName" />

            <div class="form-group">
                <label><i class="fas fa-store-alt"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                <input type="text" id="shopName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏´‡∏°‡∏≠‡∏™‡∏°‡∏ä‡∏≤‡∏¢, ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏ß‡∏¢‡πÄ‡∏à‡∏ô‡∏ô‡∏µ‡πà" required />
            </div>

            <div class="form-group">
                <label><i class="fas fa-briefcase"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</label>
                <select id="businessType" required>
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó --</option>
                    <option value="carwash">üöó ‡∏£‡πâ‡∏≤‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏ñ (Car Wash)</option>
                    <option value="clinic">üè• ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (Clinic)</option>
                    <option value="salon">üíá‚Äç‚ôÄÔ∏è ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏ß‡∏¢/‡∏ó‡∏≥‡∏ú‡∏° (Salon)</option>
                </select>
            </div>

            <div id="loadingMessage" style="text-align:center; color:#666; display:none;">
                <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE...
            </div>

            <button type="submit" id="submitBtn" disabled>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô (Login w/ LINE)</button>
        </form>

        <div id="statusMessage"></div>
    </div>

    <script>
        // --- Configuration ---
        const SUPABASE_URL = "https://vprtarhfpjcgshciadca.supabase.co";
        const SUPABASE_KEY = "sb_publishable__s23ahvDwKLlv78MF-xBDA_MyI02PYq";
        const LIFF_ID = "2008806162-K39SJq6X"; // Use a LIFF ID that allows this URL

        // Define client with a different name to avoid conflict with global 'supabase'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function main() {
            try {
                const btn = document.getElementById("submitBtn");
                const loader = document.getElementById("loadingMessage");

                loader.style.display = "block";
                btn.style.display = "none";

                await liff.init({ liffId: LIFF_ID });

                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById("ownerLineId").value = profile.userId;
                    document.getElementById("ownerDisplayName").value = profile.displayName;

                    loader.style.display = "none";
                    btn.style.display = "block";
                    btn.disabled = false;
                    btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
                }
            } catch (err) {
                console.error("LIFF Init failed", err);
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed; top:20%; left:10%; right:10%; background:white; color:red; padding:20px; text-align:center; border:2px solid red; z-index:9999; border-radius:10px; box-shadow:0 10px 20px rgba(0,0,0,0.2);';
                errorDiv.innerHTML = '<h3>LIFF Error</h3><p>' + (err.message || err) + '</p><p style="font-size:12px; color:#666;">' + (err.code || '') + '</p>';
                document.body.appendChild(errorDiv);
            }
        }

        main();

        document.getElementById("registerForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("shopName").value;
            const type = document.getElementById("businessType").value;
            const lineId = document.getElementById("ownerLineId").value;

            if (!lineId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä");

            const btn = document.getElementById("submitBtn");
            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤...";

            // Insert into Shops
            const { data, error } = await supabaseClient
                .from('shops')
                .insert([
                    {
                        name: name,
                        business_type: type,
                        owner_line_id: lineId,
                        status: 'trial'
                    }
                ])
                .select();

            if (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                btn.disabled = false;
                btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô";
            } else {
                const shopId = data[0].id;
                // Success! Redirect to dashboard or show link
                document.querySelector('.container').innerHTML = `
                    <div style="text-align:center;">
                        <i class="fas fa-check-circle fa-4x" style="color:#2ecc71; margin-bottom:20px;"></i>
                        <h2>‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                        <p>‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠:</p>
                        <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin:15px 0; word-break:break-all;">
                            https://yourdomain.com/index.html?shop_id=${shopId}
                        </div>
                        <p>‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>
